VFS

​	实现封装，实现多态



怎么使用函数指针！！





文件操作



文件动态共享

​		1.不同进程访问同一文件时，该文件的数据部分在内存中只存在一份拷贝

​						（管数据使用i-node防止多次拷贝）

​					对于文件类型的函数在内存中只有一份拷贝。

​							（管理用v-node）

​		2.进程以独立的方式访问文件。

​							（系统打开文件列表fillenode）

​			processA

​			PCB(task_struck)

​			内核把进程列表放在任务队列里面（双向列表）

​			用户打开文件列表

PV

非录像进程共享

​		v-node项实现统一文件共享

​		也就是对v-node互尺操作（原子操作）	

​	

​		相同文件在文件系统表中存独立的表项，也就是对文件访问位置相对独立

​		

​		亲源进程见由于派生时候会复制文件描述符表，因此他们通过共享系统打开文件列表实现文件共享

​		他们对文件访问位置是相互可见

​		对系统打开文件爱呢列表应该相互排斥



​		非亲源通过不同的系统打开文件列表位置来保证相互独立访问

![1569316022829](/home/xu/.config/Typora/typora-user-images/1569316022829.png)

给出了这些数据结构后,现在对前面所述的操作作进一步说明。
• 在完成每个 w r i t e后,在文件表项中的当前文件位移量即增加所写的字节数。如果这使当
前文件位移量超过了当前文件长度,则在 i节点表项中的当前文件长度被设置为当前文件位移
量(也就是该文件加长了)。
• 如果用O _ A P P E N D标志打开了一个文件,则相应标志也被设置到文件表项的文件状态标
志中。每次对这种具有添写标志的文件执行写操作时,在文件表项中的当前文件位移量首先被
设置为i节点表项中的文件长度。这就使得每次写的数据都添加到文件的当前尾端处。
• lseek函数只修改文件表项中的当前文件位移量,没有进行任何 I / O操作。
• 若一个文件用l s e e k被定位到文件当前的尾端,则文件表项中的当前文件位移量被设置为 i
节点表项中的当前文件长度。
可能有多个文件描述符项指向同一文件表项。在 3 . 1 2节中讨论 d u p函数时,我们就能看到
这一点。在f o r k后也发生同样的情况,此时父、子进程对于每一个打开的文件描述符共享同一
个文件表项。
注意,文件描述符标志和文件状态标志在作用范围方面的区别,前者只用于一个进程的一
个描述符,而后者则适用于指向该给定文件表项的任何进程中的所有描述符。在 3 . 1 3节说明
f c n t l函数时,我们将会了解如何存取和修改文件描述符标志和文件状态标志。
上述的一切对于多个进程读同一文件都能正确工作。每个进程都有它自己的文件表项,其第 3章 文 件 I/O
4 5
中也有它自己的当前文件位移量。但是,当多个进程写同一文件时,则可能产生预期不到的结
果。为了说明如何避免这种情况,需要理解原子操作的概念。



假定有两个独立的进程 A和B,都对同一文件进行添加操作。每个进程都已打开了该文件,
但未使用 O _ A P P E N D标志。此时各数据结构之间的关系如图 3 - 2中所示一样。每个进程都有它
自己的文件表项,但是共享一个 v节点表项。假定进程A调用了l s e e k,它将对于进程 A的该文件
的当前位移量设置为1 5 0 0字节(当前文件尾端处)。然后内核切换进程使进程 B运行。进程B执行
l s e e k,也将其对该文件的当前位移量设置为 1 5 0 0字节(当前文件尾端处 )。然后B调用w r i t e,它
将B的该文件的当前文件位移量增至 1 6 0 0。因为该文件的长度已经增加了,所以内核对 v节点
中的当前文件长度更新为 1 6 0 0。然后,内核又进行进程切换使进程 A恢复运行。当 A调用w r i t e
时,就从其当前文件位移量 ( 1 5 0 0 )处将数据写到文件中去。这样也就代换了进程 B刚写到该文
件中的数据。
这里的问题出在逻辑操作“定位档到文件尾端处,然后写”使用了两个分开的函数调用。
解决问题的方法是使这两个操作对于其他进程而言成为一个原子操作。任何一个要求多于 1个
函数调用的操作都不能成为原子操作,因为在两个函数调用之间,内核有可能会临时挂起该进
程(正如我们前面所假定的)。
U N I X 提供了一种方法使这种操作成为原子操作,其方法就是在打开文件时设置
O _ A P P E N D标志。正如前一节中所述,这就使内核每次对这种文件进行写之前,都将进程的
当前位移量设置到该文件的尾端处,于是在每次写之前就不再需要调用 l s e e k。



dup对用户打开文件列表修改





完成作业3.4和3.6





